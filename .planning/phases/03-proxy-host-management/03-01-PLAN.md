---
phase: 03-proxy-host-management
plan: 01
type: execute
---

<objective>
Create API exceptions module and proxy host Pydantic models with full NPM schema validation.

Purpose: Establish type-safe foundation for NPM proxy host API interactions with strict validation to detect schema changes.
Output: Custom API exceptions for error handling, complete Pydantic models for proxy host CRUD operations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-proxy-host-management/03-RESEARCH.md
@src/npm_cli/api/models.py
@src/npm_cli/api/client.py
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Create API exceptions module</name>
  <files>src/npm_cli/api/exceptions.py, tests/test_api_exceptions.py</files>
  <test-first>
    Test: NPMAPIError preserves response details, NPMConnectionError for connection failures, NPMValidationError wraps Pydantic errors
    Cases:
    - NPMAPIError with response object includes status code and response text
    - NPMConnectionError with helpful message
    - NPMValidationError preserves original Pydantic ValidationError
  </test-first>
  <action>
    Create custom exception hierarchy:
    - NPMAPIError(Exception): Base for API errors, stores optional httpx.Response for debugging
    - NPMConnectionError(NPMAPIError): Connection failures (cannot reach NPM)
    - NPMValidationError(NPMAPIError): Schema validation failures, stores Pydantic ValidationError

    Each exception should have clear __str__ for Rich console output.
    Store response object to enable detailed error messages in CLI (status code, response body excerpt).
  </action>
  <verify>pytest tests/test_api_exceptions.py -v passes</verify>
  <done>Exception classes handle all error scenarios, preserve debugging context, tests verify error messages</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Add proxy host Pydantic models</name>
  <files>src/npm_cli/api/models.py, tests/test_proxy_models.py</files>
  <test-first>
    Test: ProxyHostCreate validates required fields, ProxyHost includes read-only fields, ProxyHostUpdate allows partial updates
    Cases:
    - ProxyHostCreate requires domain_names, forward_scheme, forward_host, forward_port
    - ProxyHostCreate rejects extra fields (extra="forbid")
    - ProxyHost includes id, created_on, modified_on, owner_user_id
    - ProxyHostUpdate makes all fields optional
    - Domain names limited to max 15 items
    - Forward port range 1-65535
  </test-first>
  <action>
    Add three Pydantic models based on NPM JSON Schema v2.9.6 from RESEARCH.md:

    ProxyHostCreate (request for POST):
    - domain_names: list[str] (min=1, max=15)
    - forward_scheme: Literal["http", "https"]
    - forward_host: str (min=1, max=255)
    - forward_port: int (1-65535)
    - certificate_id: int | Literal["new"] = 0
    - ssl_forced: bool = False
    - hsts_enabled: bool = False
    - hsts_subdomains: bool = False
    - http2_support: bool = True
    - block_exploits: bool = True
    - caching_enabled: bool = False
    - allow_websocket_upgrade: bool = False
    - access_list_id: int = 0 (ge=0)
    - advanced_config: str = ""
    - enabled: bool = True
    - meta: dict = {}
    - locations: list[dict] = []
    All with model_config = ConfigDict(extra="forbid", strict=True)

    ProxyHost (response from GET/POST/PUT) - inherits ProxyHostCreate, adds:
    - id: int (ge=1)
    - created_on: str (ISO 8601)
    - modified_on: str (ISO 8601)
    - owner_user_id: int (ge=1)

    ProxyHostUpdate (request for PUT) - all fields optional:
    - Same fields as ProxyHostCreate but all Optional[type]
    - model_config = ConfigDict(extra="forbid", strict=True)

    Use Field() with validators from RESEARCH.md code examples.
    Follow existing pattern from TokenRequest/TokenResponse.
  </action>
  <verify>pytest tests/test_proxy_models.py -v passes, mypy src/npm_cli/api/models.py shows no errors</verify>
  <done>All three models validate correctly, reject extra fields, enforce constraints (domain count, port range), pass type checking</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest passes all tests
- [ ] Models follow strict validation pattern (extra="forbid")
- [ ] Exception classes preserve error context
- [ ] No type errors in models or exceptions
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- API exceptions provide clear error messages with context
- Proxy host models match NPM JSON Schema v2.9.6
- TDD commits show RED-GREEN pattern
</success_criteria>

<output>
After completion, create `.planning/phases/03-proxy-host-management/03-01-SUMMARY.md`:

# Phase 3 Plan 1: API Foundation Summary

**[One-liner about what shipped]**

## Accomplishments

- Created custom API exception hierarchy for error handling
- Implemented complete proxy host Pydantic models with NPM schema validation
- TDD workflow with failing tests first, implementation second

## Files Created/Modified

- `src/npm_cli/api/exceptions.py` - Custom exceptions with response context
- `src/npm_cli/api/models.py` - ProxyHost, ProxyHostCreate, ProxyHostUpdate models
- `tests/test_api_exceptions.py` - Exception validation tests
- `tests/test_proxy_models.py` - Proxy model validation tests

## Decisions Made

[Any implementation decisions or deviations from plan]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-02-PLAN.md (API Client CRUD methods)
</output>
