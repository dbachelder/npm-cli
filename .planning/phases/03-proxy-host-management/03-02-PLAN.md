---
phase: 03-proxy-host-management
plan: 02
type: execute
---

<objective>
Extend NPMClient with proxy host CRUD operations using httpx connection pooling and strict Pydantic validation.

Purpose: Provide type-safe API methods for proxy host management with comprehensive error handling.
Output: NPMClient methods for list, get, create, update, delete proxy hosts with proper exception handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-proxy-host-management/03-RESEARCH.md
@.planning/phases/03-proxy-host-management/03-01-SUMMARY.md
@src/npm_cli/api/client.py
@src/npm_cli/api/models.py
@src/npm_cli/api/exceptions.py
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Add list and get proxy host methods</name>
  <files>src/npm_cli/api/client.py, tests/test_npm_client_proxy.py</files>
  <test-first>
    Test: list_proxy_hosts returns list of ProxyHost objects, get_proxy_host returns single ProxyHost
    Cases:
    - list_proxy_hosts() calls GET /api/nginx/proxy-hosts, validates response
    - get_proxy_host(id) calls GET /api/nginx/proxy-hosts/{id}, validates response
    - Both raise NPMConnectionError on connection failure
    - Both raise NPMAPIError on HTTP errors (404, 500)
    - Both raise NPMValidationError on schema mismatch
    Use pytest-mock to mock httpx responses
  </test-first>
  <action>
    Add two methods to NPMClient class:

    def list_proxy_hosts(self) -> list[ProxyHost]:
        """GET /api/nginx/proxy-hosts - List all proxy hosts"""
        - Use self.request("GET", "/api/nginx/proxy-hosts")
        - Validate response with [ProxyHost.model_validate(item) for item in response.json()]
        - Wrap httpx.HTTPStatusError in NPMAPIError with response context
        - Wrap httpx.ConnectError in NPMConnectionError
        - Wrap ValidationError in NPMValidationError

    def get_proxy_host(self, host_id: int) -> ProxyHost:
        """GET /api/nginx/proxy-hosts/{id} - Get single proxy host"""
        - Use self.request("GET", f"/api/nginx/proxy-hosts/{host_id}")
        - Validate response with ProxyHost.model_validate(response.json())
        - Special case: 404 → NPMAPIError(f"Proxy host {host_id} not found")
        - Other errors same as list_proxy_hosts

    Follow pattern from RESEARCH.md code examples (line 303-335).
    Use existing self.request() method which handles token validation.
    Import exceptions from npm_cli.api.exceptions.
  </action>
  <verify>pytest tests/test_npm_client_proxy.py::test_list_proxy_hosts -v passes, pytest tests/test_npm_client_proxy.py::test_get_proxy_host -v passes</verify>
  <done>Both methods implemented, all error cases handled with appropriate exceptions, tests verify response validation and error handling</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Add create, update, delete proxy host methods</name>
  <files>src/npm_cli/api/client.py, tests/test_npm_client_proxy.py</files>
  <test-first>
    Test: create_proxy_host accepts ProxyHostCreate, update_proxy_host accepts ProxyHostUpdate, delete_proxy_host returns None
    Cases:
    - create_proxy_host(ProxyHostCreate) → POST /api/nginx/proxy-hosts → ProxyHost
    - update_proxy_host(id, ProxyHostUpdate) → PUT /api/nginx/proxy-hosts/{id} → ProxyHost
    - delete_proxy_host(id) → DELETE /api/nginx/proxy-hosts/{id} → None
    - All raise appropriate exceptions (NPMConnectionError, NPMAPIError, NPMValidationError)
    - create/update use model_dump(exclude_none=True, mode="json") per RESEARCH.md
  </test-first>
  <action>
    Add three methods to NPMClient class:

    def create_proxy_host(self, host: ProxyHostCreate) -> ProxyHost:
        """POST /api/nginx/proxy-hosts - Create new proxy host"""
        - Use self.request("POST", "/api/nginx/proxy-hosts", json=host.model_dump(exclude_none=True, mode="json"))
        - Validate response with ProxyHost.model_validate(response.json())
        - Handle errors same as get_proxy_host

    def update_proxy_host(self, host_id: int, updates: ProxyHostUpdate) -> ProxyHost:
        """PUT /api/nginx/proxy-hosts/{id} - Update proxy host"""
        - Use self.request("PUT", f"/api/nginx/proxy-hosts/{host_id}", json=updates.model_dump(exclude_none=True, mode="json"))
        - Validate response with ProxyHost.model_validate(response.json())
        - Special case: 404 → NPMAPIError(f"Proxy host {host_id} not found")

    def delete_proxy_host(self, host_id: int) -> None:
        """DELETE /api/nginx/proxy-hosts/{id} - Delete proxy host"""
        - Use self.request("DELETE", f"/api/nginx/proxy-hosts/{host_id}")
        - No response body validation (DELETE returns empty)
        - Special case: 404 → NPMAPIError(f"Proxy host {host_id} not found")
        - raise_for_status() to catch other errors

    Follow RESEARCH.md pattern (line 337-378).
    Use exclude_none=True to avoid sending null fields to API.
    Use mode="json" for proper serialization of Literal types.
  </action>
  <verify>pytest tests/test_npm_client_proxy.py -v passes all create/update/delete tests</verify>
  <done>All CRUD methods implemented, error handling comprehensive, tests verify request payloads and response validation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest passes all NPMClient proxy tests
- [ ] All 5 methods properly handle authentication (use self.request)
- [ ] Error messages include response context for debugging
- [ ] Pydantic validation catches schema changes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- NPMClient supports full proxy host CRUD lifecycle
- Comprehensive error handling with custom exceptions
- TDD commits demonstrate RED-GREEN pattern
</success_criteria>

<output>
After completion, create `.planning/phases/03-proxy-host-management/03-02-SUMMARY.md`:

# Phase 3 Plan 2: API Client CRUD Summary

**[One-liner about what shipped]**

## Accomplishments

- Extended NPMClient with 5 proxy host methods (list, get, create, update, delete)
- Comprehensive error handling with NPMConnectionError, NPMAPIError, NPMValidationError
- TDD workflow with mocked httpx responses

## Files Created/Modified

- `src/npm_cli/api/client.py` - Added 5 proxy host CRUD methods
- `tests/test_npm_client_proxy.py` - Tests for all CRUD operations and error cases

## Decisions Made

[Any implementation decisions or deviations from plan]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-03-PLAN.md (CLI Commands with Rich output and verification)
</output>
