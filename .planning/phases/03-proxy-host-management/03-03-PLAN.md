---
phase: 03-proxy-host-management
plan: 03
type: execute
---

<objective>
Implement proxy CLI commands with Rich-formatted output for interactive proxy host management.

Purpose: Provide user-friendly commands for listing, creating, updating, and deleting proxy hosts with beautiful table output and clear error messages.
Output: Complete `npm-cli proxy` command suite with list, create, update, delete, show subcommands.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-proxy-host-management/03-RESEARCH.md
@.planning/phases/03-proxy-host-management/03-01-SUMMARY.md
@.planning/phases/03-proxy-host-management/03-02-SUMMARY.md
@src/npm_cli/cli/config.py
@src/npm_cli/__main__.py
@src/npm_cli/api/client.py
@src/npm_cli/api/models.py
@src/npm_cli/api/exceptions.py
@src/npm_cli/config/settings.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create proxy CLI module with list command</name>
  <files>src/npm_cli/cli/proxy.py</files>
  <action>
    Create new Typer app for proxy commands:

    Structure:
    - Import: typer, Rich Console, Rich Table, NPMClient, settings, exceptions
    - Create app = typer.Typer(name="proxy", help="Manage proxy hosts")
    - Create console = Console()

    Implement list command:
    @app.command("list")
    def list_proxy_hosts():
        """List all proxy hosts"""
        - Load settings from config (same pattern as config.py)
        - Create NPMClient with context manager: with NPMClient(settings.npm_url, timeout=30.0) as client
        - Authenticate if token expired: client.authenticate(settings.npm_username, settings.npm_password)
        - Call client.list_proxy_hosts()
        - If empty: console.print("[yellow]No proxy hosts found[/]")
        - Create Rich Table with columns: ID (cyan), Domains (green), Forward To (yellow), SSL (magenta), Status (blue)
        - Format domains as newline-joined string
        - Format forward as "{scheme}://{host}:{port}"
        - SSL column: "✓" if certificate_id else "✗"
        - Status: "[green]Enabled[/]" if enabled else "[red]Disabled[/]"
        - Handle NPMConnectionError, NPMAPIError, NPMValidationError with helpful messages
        - Exit with code 1 on errors

    Follow RESEARCH.md pattern (line 473-512).
    Use show_lines=True for table readability with multi-line domains.
    Import NPMSettings from npm_cli.config.settings.
  </action>
  <verify>uv run npm-cli proxy list shows table or "No proxy hosts found" without errors</verify>
  <done>List command works, displays Rich table, handles errors gracefully</done>
</task>

<task type="auto">
  <name>Task 2: Add create, show, update, delete commands</name>
  <files>src/npm_cli/cli/proxy.py</files>
  <action>
    Add four commands to proxy app:

    @app.command("create")
    def create_proxy_host(
        domain: str = typer.Argument(..., help="Domain name (e.g., app.example.com)"),
        forward_host: str = typer.Option(..., "--host", "-h", help="Backend hostname/IP"),
        forward_port: int = typer.Option(..., "--port", "-p", help="Backend port"),
        forward_scheme: Literal["http", "https"] = typer.Option("http", "--scheme", "-s"),
        ssl: bool = typer.Option(False, "--ssl", help="Force SSL redirect"),
        websocket: bool = typer.Option(False, "--websocket", "-w", help="Allow WebSocket upgrade"),
        http2: bool = typer.Option(True, "--http2", help="Enable HTTP/2 support"),
    ):
        """Create a new proxy host"""
        - Create ProxyHostCreate with provided args
        - Set allow_websocket_upgrade=websocket, http2_support=http2, ssl_forced=ssl
        - Call client.create_proxy_host(host_data)
        - Print success: "[green]✓[/] Created proxy host [cyan]{id}[/]"
        - Show details: domain, forward URL, SSL status, WebSocket status

    @app.command("show")
    def show_proxy_host(host_id: int = typer.Argument(..., help="Proxy host ID")):
        """Show detailed proxy host information"""
        - Call client.get_proxy_host(host_id)
        - Create Rich Panel with title "Proxy Host {id}"
        - Display all fields: domains (one per line), forward, SSL, HSTS, caching, etc.
        - Use Panel with border for visual separation

    @app.command("update")
    def update_proxy_host(
        host_id: int = typer.Argument(..., help="Proxy host ID"),
        domain: list[str] = typer.Option(None, "--domain", "-d", help="Domain names (repeat for multiple)"),
        forward_host: str = typer.Option(None, "--host", "-h"),
        forward_port: int = typer.Option(None, "--port", "-p"),
        forward_scheme: Literal["http", "https"] = typer.Option(None, "--scheme", "-s"),
        ssl: bool = typer.Option(None, "--ssl"),
        enabled: bool = typer.Option(None, "--enabled/--disabled"),
    ):
        """Update proxy host configuration"""
        - Build ProxyHostUpdate with only provided fields (exclude_none=True handles this)
        - Call client.update_proxy_host(host_id, updates)
        - Print success with updated field summary

    @app.command("delete")
    def delete_proxy_host(
        host_id: int = typer.Argument(..., help="Proxy host ID"),
        yes: bool = typer.Option(False, "--yes", "-y", help="Skip confirmation"),
    ):
        """Delete a proxy host"""
        - If not yes: prompt with typer.confirm(f"Delete proxy host {host_id}?", abort=True)
        - Call client.delete_proxy_host(host_id)
        - Print success: "[green]✓[/] Deleted proxy host [cyan]{host_id}[/]"

    All commands follow same error handling pattern as list.
    Import Literal from typing.
    Import Panel from rich.panel for show command.
  </action>
  <verify>uv run npm-cli proxy create/show/update/delete commands work without syntax errors</verify>
  <done>All four commands implemented, proper argument/option handling, Rich output formatting</done>
</task>

<task type="auto">
  <name>Task 3: Register proxy commands in main CLI</name>
  <files>src/npm_cli/__main__.py</files>
  <action>
    Register proxy subcommand group:
    - Import: from npm_cli.cli.proxy import app as proxy_app
    - Add to main app: app.add_typer(proxy_app, name="proxy")

    Follow existing pattern from config commands.
    Place import with other CLI imports.
    Place registration with other add_typer calls.
  </action>
  <verify>uv run npm-cli --help shows "proxy" in commands list, uv run npm-cli proxy --help shows subcommands</verify>
  <done>Proxy commands registered, help text displays correctly</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete proxy host CRUD CLI with list, create, show, update, delete commands</what-built>
  <how-to-verify>
    1. Ensure NPM is running and configured (uv run npm-cli config status should show connected)
    2. List existing proxy hosts: uv run npm-cli proxy list
    3. Create test proxy host: uv run npm-cli proxy create test.local --host localhost --port 8080
    4. Verify creation in list: uv run npm-cli proxy list (should show test.local)
    5. Show details: uv run npm-cli proxy show [ID from step 4]
    6. Update proxy host: uv run npm-cli proxy update [ID] --enabled --ssl
    7. Verify update in show: uv run npm-cli proxy show [ID] (enabled=true, ssl_forced=true)
    8. Delete test proxy: uv run npm-cli proxy delete [ID] --yes
    9. Verify deletion: uv run npm-cli proxy list (test.local should be gone)
    10. Test error handling: uv run npm-cli proxy show 99999 (should show "not found" error)
    11. Verify Rich formatting: tables have borders, colors work, multi-domain display works
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All proxy commands registered and accessible
- [ ] Rich tables display correctly with colors and formatting
- [ ] Error handling provides clear, helpful messages
- [ ] Manual testing confirms CRUD operations work against NPM
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Complete proxy host management via CLI
- User-friendly Rich output with tables and panels
- Comprehensive error handling for all failure scenarios
- Phase 3 complete - proxy host CRUD fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/03-proxy-host-management/03-03-SUMMARY.md`:

# Phase 3 Plan 3: CLI Commands Summary

**[One-liner about what shipped]**

## Accomplishments

- Implemented complete proxy CLI with 5 commands (list, create, show, update, delete)
- Rich-formatted output with tables, panels, and color-coded status
- Interactive confirmation for destructive operations
- Comprehensive error handling with user-friendly messages

## Files Created/Modified

- `src/npm_cli/cli/proxy.py` - Complete proxy command suite
- `src/npm_cli/__main__.py` - Registered proxy commands

## Decisions Made

[Any implementation decisions or deviations from plan]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

**Phase 3 complete!** Proxy host management fully implemented.

Ready for Phase 4: SSL Certificate Automation

Dependencies met:
- ✓ Proxy host CRUD operations via NPM API
- ✓ Rich CLI output for user-friendly interaction
- ✓ Comprehensive error handling
- ✓ Verification against live NPM instance

---
*Phase: 03-proxy-host-management*
*Completed: [Date]*
</output>
