---
phase: 08-proxy-clone-command
type: execute
---

<objective>
Implement proxy host cloning with automatic SSL certificate provisioning for new domains.

Purpose: Simplify creating similar proxy configurations by cloning existing hosts with new domains, automatically provisioning SSL certificates if the source has one.
Output: Working `npm-cli proxy clone` command that copies all configuration from source proxy to new domain(s) with automatic SSL setup.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/npm_cli/api/client.py
@src/npm_cli/api/models.py
@src/npm_cli/cli/proxy.py
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Add clone_proxy_host method to NPMClient with TDD</name>
  <files>src/npm_cli/api/client.py, tests/test_clone.py</files>
  <test-first>
    Test: clone_proxy_host copies configuration from source to new domain
    Cases:
    - Without certificate: Copy all fields except domain_names and certificate_id, set new domain
    - With certificate: Copy all fields, create new cert for new domain, attach to new proxy
    - Domain lookup: Accept ID or domain name as source identifier (like show command)
    - Preserve: forward_*, ssl_forced, hsts_*, http2_support, advanced_config, enabled, etc.
    - Reset: certificate_id (replaced if source had cert), domain_names (new domain)
  </test-first>
  <action>
Add clone_proxy_host method to NPMClient class after delete_proxy_host method (around line 340).

Method signature:
```python
def clone_proxy_host(
    self,
    source_identifier: str | int,
    new_domains: list[str],
    provision_ssl: bool = True
) -> ProxyHost:
```

Implementation logic:
1. Look up source proxy host:
   - If source_identifier is int: call get_proxy_host(source_identifier)
   - If source_identifier is str: call list_proxy_hosts(), search domain_names for match (like show command pattern line 176-194)
   - Raise ValueError if not found or multiple matches

2. Create ProxyHostCreate from source fields:
   - Copy these fields: forward_scheme, forward_host, forward_port, ssl_forced, hsts_enabled, hsts_subdomains, http2_support, block_exploits, caching_enabled, allow_websocket_upgrade, access_list_id, advanced_config, enabled
   - Set domain_names to new_domains parameter
   - Set certificate_id to None (will be set later if SSL provisioning)

3. If provision_ssl is True AND source.certificate_id is not None:
   - Create CertificateCreate for new_domains (provider="letsencrypt", domain_names=new_domains, meta={})
   - Call certificate_create to get new cert
   - Set certificate_id on ProxyHostCreate to new cert id

4. Call create_proxy_host with the constructed ProxyHostCreate
5. Return the created ProxyHost

Use existing patterns from attach_certificate_to_proxy (line 465-513) for certificate workflow and show_proxy_host (line 176-194) for domain lookup.
  </action>
  <verify>pytest tests/test_clone.py passes - tests clone without cert, clone with cert, domain lookup, field preservation</verify>
  <done>clone_proxy_host method exists, handles both ID and domain lookup, copies configuration correctly, provisions SSL when source has cert, all tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add clone CLI command with Rich output</name>
  <files>src/npm_cli/cli/proxy.py</files>
  <action>
Add clone command to proxy.py after delete_proxy_host command (around line 370).

Command signature:
```python
@app.command("clone")
def clone_proxy_host(
    source: str = typer.Argument(..., help="Source proxy host ID or domain name"),
    new_domain: str = typer.Argument(..., help="New domain name(s) - comma-separated for multiple"),
    no_ssl: bool = typer.Option(False, "--no-ssl", help="Skip SSL certificate provisioning even if source has cert"),
) -> None:
```

Implementation:
1. Parse new_domain: split by comma, strip whitespace → list[str]
2. Load NPMSettings, create NPMClient, authenticate (standard pattern from other commands)
3. Call client.clone_proxy_host(source, new_domains, provision_ssl=not no_ssl)
4. Rich output using console.print:
   - Success panel with green border
   - Show: New proxy ID, domain names, backend (scheme://host:port)
   - If SSL provisioned: Show certificate ID and "SSL certificate created and attached"
   - If no SSL: Show "No SSL certificate (--no-ssl used)" or "Source had no certificate"
5. Error handling: NPMConnectionError, NPMAPIError, NPMValidationError, ValueError (standard pattern)

Follow existing command patterns from create_proxy_host (line 88-159) and show_proxy_host (line 160-247) for:
- Settings loading and authentication
- Rich console formatting
- Error handling with helpful messages
  </action>
  <verify>
Manual testing:
1. uv run npm-cli proxy clone app.example.com app2.example.com → clones with SSL if source has it
2. uv run npm-cli proxy clone 5 test.example.com --no-ssl → clones by ID without SSL
3. uv run npm-cli proxy clone nonexistent fail.com → error message
4. uv run npm-cli proxy list → verify new proxy exists with correct config
  </verify>
  <done>clone command works with ID or domain lookup, provisions SSL automatically (unless --no-ssl), displays clear success/error messages, follows existing CLI patterns</done>
</task>

<task type="auto">
  <name>Task 3: Update README with featured clone command documentation</name>
  <files>README.md</files>
  <action>
Update README.md to prominently feature the clone command:

1. **Features section** (around line 8-20):
   Add as second bullet point after "Proxy Host Management":
   - **Proxy Cloning** - Clone existing proxy hosts to new domains with automatic SSL certificate provisioning

2. **Quick Start section** (after line 98):
   Add new subsection "### 5. Clone Existing Proxies" before the "Usage Examples" section:
   ```markdown
   ### 5. Clone Existing Proxies

   Quickly create similar proxy configurations by cloning:

   ```bash
   # Clone with automatic SSL provisioning (if source has cert)
   npm-cli proxy clone app.example.com app2.example.com

   # Clone without SSL even if source has it
   npm-cli proxy clone app.example.com test.example.com --no-ssl

   # Clone by ID
   npm-cli proxy clone 42 newapp.example.com
   ```

   The clone command copies all configuration (backend, SSL settings, advanced config, templates) from the source proxy to new domain(s), automatically provisioning a new SSL certificate if the source has one attached.
   ```

3. **Command Reference - Proxy Commands section** (find the proxy commands section):
   Add after `proxy create` example (likely around line 150-200):
   ```markdown
   #### Clone Proxy Host

   Clone an existing proxy to new domain(s) with automatic SSL provisioning:

   ```bash
   # Clone by domain name (auto-provisions SSL if source has cert)
   npm-cli proxy clone source.example.com new.example.com

   # Clone by ID
   npm-cli proxy clone 5 clone.example.com

   # Clone without SSL certificate provisioning
   npm-cli proxy clone app.example.com test.example.com --no-ssl

   # Clone to multiple domains (comma-separated)
   npm-cli proxy clone app.example.com "app1.local,app2.local"
   ```

   **What gets cloned:**
   - All backend configuration (scheme, host, port)
   - SSL settings (forced HTTPS, HSTS)
   - Advanced nginx configuration
   - WebSocket support
   - Access lists
   - All other proxy settings

   **What changes:**
   - Domain names (replaced with new domain)
   - SSL certificate (new cert created if source has one, unless --no-ssl)
   ```

Position this prominently - clone should be highlighted as a key productivity feature.
  </action>
  <verify>
git diff README.md shows:
- Clone feature added to Features list
- New Quick Start section 5 with clone examples
- Detailed clone command reference with examples
- Clear explanation of what gets cloned vs. what changes
  </verify>
  <done>README prominently features clone command in Features, Quick Start, and Command Reference sections with clear examples and explanations</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Proxy clone command with automatic SSL provisioning</what-built>
  <how-to-verify>
    1. Start NPM: docker compose up -d (or use existing instance)
    2. Ensure NPM credentials set: export NPM_USERNAME="admin@example.com" NPM_PASSWORD="..."
    3. Create test proxy: uv run npm-cli proxy create test-source.local --host 192.168.1.100 --port 8080
    4. Test clone without SSL: uv run npm-cli proxy clone test-source.local test-clone1.local --no-ssl
       - Verify: New proxy exists with same backend, no certificate
    5. Create proxy with cert: Create cert first, attach to test-source.local
    6. Test clone with SSL: uv run npm-cli proxy clone test-source.local test-clone2.local
       - Verify: New proxy exists with new certificate attached, same backend/config
    7. Test domain lookup: uv run npm-cli proxy clone test-clone1.local test-clone3.local
       - Verify: Domain-based lookup works (not just ID)
    8. Verify in NPM UI: All 4 proxies exist with expected configuration
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] pytest tests/test_clone.py passes
- [ ] npm-cli proxy clone works with ID and domain lookup
- [ ] SSL provisioning works automatically when source has certificate
- [ ] --no-ssl flag skips certificate provisioning
- [ ] All configuration fields copied correctly (backend, SSL settings, advanced_config)
- [ ] Rich output displays clear success/error messages
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- clone_proxy_host method tested and working
- CLI command follows existing patterns (auth, error handling, Rich output)
- SSL certificates automatically provisioned for cloned proxies
- Phase 8 complete - proxy clone workflow functional
  </success_criteria>

<output>
After completion, create `.planning/phases/08-proxy-clone-command/08-01-SUMMARY.md`:

# Phase 8 Plan 1: Proxy Clone Command Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 8 complete - all roadmap phases finished! Package ready for v0.1.1 release with proxy clone feature.
</output>
