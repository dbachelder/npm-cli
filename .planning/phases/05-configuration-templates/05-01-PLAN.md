---
phase: 05-configuration-templates
plan: 01
type: execute
---

<objective>
Implement configuration template system for common NPM proxy patterns (Authentik forward auth, network restrictions, webhook/API bypass, WebSocket support).

Purpose: Transform copy-paste nginx config snippets into reusable, validated templates that apply production-tested patterns with single commands.
Output: Template module with 4 core templates, apply command, and tests validating template generation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@./summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-proxy-host-management/03-03-SUMMARY.md
@.planning/phases/04-ssl-certificate-automation/04-03-SUMMARY.md
@src/npm_cli/api/models.py
@src/npm_cli/cli/proxy.py

## Key Context

**From production n8n proxy (ID 7):**
```nginx
# Unauthenticated webhook endpoints
location ~ ^/webhook(-test)?/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_pass http://n8n:5678;
}

# Unauthenticated API endpoints
location /api/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_pass http://n8n:5678;
}

# ---- Authentik forward auth outpost ----
location /outpost.goauthentik.io {
    internal;
    proxy_pass http://authentik-server:9000/outpost.goauthentik.io;
    proxy_set_header Host $host;
    proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Content-Length "";
    proxy_pass_request_body off;
}

# ---- Protect the main app with Authentik ----
location / {
    # VPN and local network only (admin UI)
    allow 10.10.10.0/24;    # WireGuard VPN network
    allow 192.168.7.0/24;   # Local LAN
    deny all;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    auth_request /outpost.goauthentik.io/auth;
    auth_request_set $auth_cookie $upstream_http_set_cookie;
    add_header Set-Cookie $auth_cookie;

    # Preserve auth headers
    auth_request_set $authentik_username $upstream_http_x_authentik_username;
    auth_request_set $authentik_groups $upstream_http_x_authentik_groups;
    proxy_set_header X-authentik-username $authentik_username;
    proxy_set_header X-authentik-groups $authentik_groups;

    proxy_pass http://n8n:5678;
}
```

**Production constraints:**
- Authentik server at `http://authentik-server:9000`
- WireGuard VPN network: `10.10.10.0/24`
- Local LAN: `192.168.7.0/24`
- WebSocket upgrade headers standard across all apps

**Decisions from prior phases:**
- ProxyHostUpdate supports `advanced_config` field (str) for nginx config
- Extra validation set to "ignore" for undocumented NPM fields
- Rich console output patterns proven successful
- TDD for business logic, skip for simple string formatting

**Template requirements (from PROJECT.md):**
- Authentik forward auth with network ACLs
- VPN-only access (network restrictions)
- API/webhook bypass paths (unauthenticated endpoints)
- WebSocket support headers
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Create template module with 4 core templates</name>
  <files>src/npm_cli/templates/__init__.py, src/npm_cli/templates/nginx.py, tests/test_templates.py</files>
  <test-first>
    Test: Template functions return correct nginx config strings
    Cases:
    - authentik_forward_auth(backend="http://app:8000", vpn_only=True) returns config with /outpost.goauthentik.io location, network ACLs, and auth_request directives
    - api_webhook_bypass(backend="http://app:8000", paths=["/api/", "/webhook/"]) returns location blocks with proxy_pass for each path
    - vpn_only_access(vpn_network="10.10.10.0/24", lan_network="192.168.7.0/24") returns allow/deny directives
    - websocket_support() returns proxy_http_version 1.1 and Upgrade/Connection headers
  </test-first>
  <action>
    Create src/npm_cli/templates/ package with nginx.py module containing 4 template functions:

    1. authentik_forward_auth(backend: str, vpn_only: bool = False, vpn_network: str = "10.10.10.0/24", lan_network: str = "192.168.7.0/24") -> str
       - Returns nginx config with /outpost.goauthentik.io internal location
       - Main location / block with auth_request, auth headers preservation, and proxy_pass to backend
       - If vpn_only=True, includes allow/deny network directives
       - Use production-tested config from n8n proxy as reference

    2. api_webhook_bypass(backend: str, paths: list[str]) -> str
       - Returns nginx config with location blocks for each path in paths list
       - Each location has standard proxy headers and proxy_pass to backend
       - WebSocket headers included (proxy_http_version 1.1, Upgrade, Connection)

    3. vpn_only_access(vpn_network: str = "10.10.10.0/24", lan_network: str = "192.168.7.0/24") -> str
       - Returns allow directives for VPN and LAN networks, deny all else
       - Inline snippet (not wrapped in location block) so it can be inserted anywhere

    4. websocket_support() -> str
       - Returns proxy_http_version 1.1, Upgrade, and Connection headers
       - Inline snippet for inserting into location blocks

    Do NOT create a generic "apply template" function yet - that's for CLI integration. These are pure functions returning nginx config strings.

    Use Python f-strings for readability. Follow existing codebase docstring patterns.
  </action>
  <verify>uv run pytest tests/test_templates.py -v passes all template generation tests</verify>
  <done>4 template functions exist, tests verify correct nginx config generation with various parameters</done>
</task>

<task type="auto">
  <name>Add template apply command to proxy CLI</name>
  <files>src/npm_cli/cli/proxy.py</files>
  <action>
    Add new command `npm-cli proxy template` to proxy.py CLI:

    Command signature:
    ```python
    @app.command("template")
    def apply_template(
        host_id: int = typer.Argument(..., help="Proxy host ID to apply template to"),
        template_name: Literal["authentik", "api-bypass", "vpn-only", "websocket"] = typer.Argument(..., help="Template to apply"),
        backend: str = typer.Option(None, "--backend", "-b", help="Backend URL (e.g., http://app:8000)"),
        paths: list[str] = typer.Option(None, "--path", "-p", help="Paths for api-bypass template (repeat for multiple)"),
        vpn_network: str = typer.Option("10.10.10.0/24", "--vpn-network", help="VPN network CIDR"),
        lan_network: str = typer.Option("192.168.7.0/24", "--lan-network", help="LAN network CIDR"),
        append: bool = typer.Option(False, "--append", "-a", help="Append to existing advanced_config instead of replacing"),
    ) -> None:
    ```

    Logic:
    1. Fetch existing proxy host by ID to get forward_host:forward_port
    2. Use backend if provided, otherwise construct from proxy host (f"{host.forward_scheme}://{host.forward_host}:{host.forward_port}")
    3. Call appropriate template function from npm_cli.templates.nginx based on template_name
    4. Validate required options (e.g., api-bypass requires --path, authentik requires backend)
    5. If --append: GET current advanced_config, append new template with newline separator
    6. If not --append: replace advanced_config entirely
    7. Update proxy host using ProxyHostUpdate with new advanced_config
    8. Print Rich-formatted success message showing template applied and config preview (first 5 lines)

    Error handling:
    - If template requires options not provided, print helpful error with example usage
    - Use existing NPMConnectionError/NPMAPIError exception handling pattern from other commands

    Do NOT modify existing proxy commands (list, create, show, update, delete). This is additive only.
  </action>
  <verify>
    uv run npm-cli proxy template --help shows new command
    Manual test: uv run npm-cli proxy list (get ID), then uv run npm-cli proxy template [ID] websocket --backend http://test:8000
    Check: uv run npm-cli proxy show [ID] displays advanced_config with WebSocket headers
  </verify>
  <done>Template command exists, accepts all 4 template types with appropriate options, updates proxy host advanced_config via API</done>
</task>

<task type="auto">
  <name>Add combined template pattern for Authentik + API bypass</name>
  <files>src/npm_cli/templates/nginx.py, tests/test_templates.py, src/npm_cli/cli/proxy.py</files>
  <action>
    1. Add 5th template function to nginx.py:
       authentik_with_bypass(backend: str, bypass_paths: list[str], vpn_only: bool = True, vpn_network: str = "10.10.10.0/24", lan_network: str = "192.168.7.0/24") -> str

       This combines api_webhook_bypass + authentik_forward_auth in correct order:
       - Bypass location blocks first (unauthenticated paths like /api/, /webhook/)
       - Authentik outpost location block
       - Main location / block with auth_request and network ACLs

       Use production n8n config as reference template - it's the proven pattern.

    2. Add test cases to tests/test_templates.py verifying:
       - Config contains all bypass path location blocks
       - Config contains /outpost.goauthentik.io internal location
       - Config contains location / with auth_request
       - Network ACLs present when vpn_only=True

    3. Add "authentik-bypass" to template_name Literal in proxy.py apply_template command
       Update validation to require --path option for authentik-bypass template

    This pattern is the most common production use case (n8n, other apps needing webhooks + auth).
  </action>
  <verify>
    uv run pytest tests/test_templates.py passes
    uv run npm-cli proxy template --help shows authentik-bypass option
  </verify>
  <done>Combined template function exists, tested, and integrated into CLI with --path validation</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `uv run pytest` passes all tests
- [ ] `uv run ruff check src/` passes with no errors
- [ ] `uv run npm-cli proxy template --help` shows command with 5 template options
- [ ] Manual test: Apply websocket template to test proxy host and verify via show command
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- 5 template functions exist in npm_cli/templates/nginx.py
- Template command integrated into proxy CLI
- Tests validate all template generation logic
- Phase 5 complete - ready for Phase 6 (Testing & Documentation)
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-templates/05-01-SUMMARY.md`:

# Phase 5 Plan 1: Configuration Templates Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Performance

- **Duration:** [X] min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** [N] tasks ([M] TDD)
- **Files modified:** [N]

## Accomplishments

- Created template module with 5 production-tested nginx config generators
- Integrated template application into proxy CLI with Rich output
- Achieved [X]% test coverage on template generation logic
- [Other key outcomes]

## Files Created/Modified

- `src/npm_cli/templates/__init__.py` - Package initialization
- `src/npm_cli/templates/nginx.py` - 5 nginx config template functions
- `tests/test_templates.py` - Comprehensive template generation tests
- `src/npm_cli/cli/proxy.py` - Added template apply command

## Decisions Made

**Template function signatures:**
- Chose pure functions returning strings over class-based approach for simplicity
- Used Literal type hints for template_name to provide autocomplete/validation
- Default network CIDRs based on production values (10.10.10.0/24, 192.168.7.0/24)

[Other decisions and rationale, or "None"]

## Deviations from Plan

### Auto-fixed Issues

[Document any bugs fixed during implementation following Phase 4 deviation pattern]

---

**Total deviations:** [N] auto-fixed, [M] deferred
**Impact on plan:** [assessment]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

**Phase 5 complete!** Configuration Templates fully implemented.

Ready for Phase 6: Testing & Documentation

Dependencies met:
- ✓ Template system with 5 core patterns
- ✓ CLI integration with proxy commands
- ✓ Test coverage on template generation
- ✓ Production-validated nginx configs

Learnings for Phase 6:
- Template functions are pure and easily testable
- Integration tests will need dedicated NPM container
- ZSH autocomplete can leverage Literal types for template names

---
*Phase: 05-configuration-templates*
*Completed: [date]*
</output>
