---
phase: 02-connection-auth
type: execute
---

<objective>
Implement Docker container discovery and NPM API authentication with token management.

Purpose: Core connection logic for locating NPM containers and authenticating with the NPM API using JWT bearer tokens.
Output: Working Docker discovery with multiple fallback strategies, NPM API client with authentication and file-based token caching.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-connection-auth/02-RESEARCH.md
@.planning/phases/02-connection-auth/02-01-SUMMARY.md
@.planning/phases/01-foundation/API-DISCOVERY.md
@src/npm_cli/api/models.py
@src/npm_cli/config/settings.py
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Implement Docker container discovery with fallback strategies</name>
  <files>src/npm_cli/docker/__init__.py, src/npm_cli/docker/discovery.py, tests/test_docker_discovery.py</files>
  <test-first>
    Test: discover_npm_container finds container using multiple strategies
    Cases:
    - Strategy 1: Find by configured container name
    - Strategy 2: Find by compose service label (com.docker.compose.service)
    - Strategy 3: Find by common name patterns (nginx-proxy-manager, npm, nginxproxymanager)
    - Returns None if no container found
    - Handles DockerException gracefully (Docker not running)
    - Extracts network settings and API URL from container
  </test-first>
  <action>Create docker/ package. Implement discover_npm_container() function following RESEARCH.md Pattern 1 and code examples. Use docker.from_env(), implement three-strategy fallback (configured name → compose label → common patterns). Add get_docker_client() helper with error handling from RESEARCH.md. Extract container network settings to determine API URL (prefer published ports, fallback to container IP). Use docker SDK filters, not manual iteration.</action>
  <verify>pytest tests/test_docker_discovery.py passes with mocked docker.Client</verify>
  <done>Docker discovery works with three fallback strategies, handles Docker unavailable gracefully, extracts network info</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Create NPM API client with JWT authentication and token caching</name>
  <files>src/npm_cli/api/client.py, tests/test_api_client.py</files>
  <test-first>
    Test: NPMClient authenticates and manages tokens
    Cases:
    - authenticate() calls POST /api/tokens with credentials, caches token to file
    - _get_token() loads cached token from file, checks expiry, returns None if expired
    - request() includes Bearer token in Authorization header
    - Token file path is ~/.npm-cli/token.json (creates directory if needed)
    - Expired tokens trigger re-authentication prompt
    - Handles authentication failures (401, invalid credentials)
  </test-first>
  <action>Create NPMClient class in api/client.py following RESEARCH.md Pattern 3. Use httpx.Client with base_url and timeout=30.0. Implement authenticate(username, password) that posts to /api/tokens using TokenRequest/TokenResponse models, saves token to Path.home() / ".npm-cli" / "token.json" as JSON. Implement _get_token() that reads file, checks expiry (datetime.fromisoformat), returns None if expired. Implement request(method, endpoint, **kwargs) that gets token, adds Authorization header, calls httpx. Raise clear error if token missing/expired. Follow RESEARCH.md pitfall #4 (always set timeout).</action>
  <verify>pytest tests/test_api_client.py passes with mocked httpx client and filesystem</verify>
  <done>NPMClient authenticates via API, caches tokens to ~/.npm-cli/token.json, validates expiry before requests, includes Bearer token in headers</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pytest tests/test_docker_discovery.py` passes
- [ ] `pytest tests/test_api_client.py` passes
- [ ] All tests use mocks (no real Docker/NPM required)
- [ ] Docker discovery handles unavailable daemon gracefully
- [ ] Token caching persists to file correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Docker discovery implements three fallback strategies
- API client authenticates and caches tokens
- Token expiry checked before requests
- Error handling for Docker unavailable and auth failures
</success_criteria>

<output>
After completion, create `.planning/phases/02-connection-auth/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Connection Core Summary

**[One-line description of what shipped]**

## Accomplishments

- Implemented Docker container discovery with three fallback strategies
- Created NPM API client with JWT authentication
- Added token caching to ~/.npm-cli/token.json with expiry validation

## Files Created/Modified

- `src/npm_cli/docker/discovery.py` - Container discovery logic
- `src/npm_cli/api/client.py` - NPM API client with authentication
- `tests/test_docker_discovery.py` - Docker discovery tests
- `tests/test_api_client.py` - API client tests

## Decisions Made

[Technical decisions, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 02-03-PLAN.md (CLI Commands)
</output>
